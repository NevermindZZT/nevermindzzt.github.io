<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Android 音频框架分析 | Letter</title><meta name="keywords" content="Android"><meta name="author" content="Letter"><meta name="copyright" content="Letter"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="初始化 系统开机启动时，加载init.rc，启动mediaserver，在Android7.0之后，启动mediaserver的脚本被分离在了audioserver.rc文件中 12345service media &#x2F;system&#x2F;bin&#x2F;mediaserver    class main    user media    group audio camera inet net_bt net_bt">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 音频框架分析">
<meta property="og:url" content="http://nevermindzzt.github.io/2020/10/15/Android%20%E9%9F%B3%E9%A2%91%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Letter">
<meta property="og:description" content="初始化 系统开机启动时，加载init.rc，启动mediaserver，在Android7.0之后，启动mediaserver的脚本被分离在了audioserver.rc文件中 12345service media &#x2F;system&#x2F;bin&#x2F;mediaserver    class main    user media    group audio camera inet net_bt net_bt">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/10/GoSLIP.jpg">
<meta property="article:published_time" content="2020-10-15T02:45:00.000Z">
<meta property="article:modified_time" content="2022-02-27T13:31:21.583Z">
<meta property="article:author" content="Letter">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2020/04/10/GoSLIP.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://nevermindzzt.github.io/2020/10/15/Android%20%E9%9F%B3%E9%A2%91%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-115327601-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-115327601-1');
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android 音频框架分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-27 21:31:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Letter" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s1.ax1x.com/2020/04/10/GI7cM6.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">12</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s1.ax1x.com/2020/04/10/GoSLIP.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Letter</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Android 音频框架分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-10-15T02:45:00.000Z" title="Created 2020-10-15 10:45:00">2020-10-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-02-27T13:31:21.583Z" title="Updated 2022-02-27 21:31:21">2022-02-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Android 音频框架分析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p><img src="/../../out/source/_posts/Android%20%E9%9F%B3%E9%A2%91%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B/Audio%20%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B.png" alt="Audio 初始化流程"></p>
<p>系统开机启动时，加载<code>init.rc</code>，启动<code>mediaserver</code>，在Android7.0之后，启动<code>mediaserver</code>的脚本被分离在了<code>audioserver.rc</code>文件中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">service media /system/bin/mediaserver</span><br><span class="line">    class main</span><br><span class="line">    user media</span><br><span class="line">    group audio camera inet net_bt net_bt_admin net_bw_acct drmrpc mediadrm</span><br><span class="line">    ioprio rt 4</span><br></pre></td></tr></table></figure>

<p><code>mediaserver</code>源码位置为<code>frameworks/av/media/mediaserver</code>，<code>mediaserver</code>目录中主要只有<code>main_mediaserver.cpp</code>一个文件，用于启动<code>AudioFlinger</code>, <code>AudioPolicyService</code>, <code>RadioService</code>等服务，其中与音频相关的主要是<code>AudioFlinger</code>和<code>AudioPolicyService</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc __unused, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (doLog &amp;&amp; (childPid = fork()) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/** 启动log线程 */</span></span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        AudioFlinger::<span class="built_in">instantiate</span>();</span><br><span class="line">        MediaPlayerService::<span class="built_in">instantiate</span>();</span><br><span class="line">        ResourceManagerService::<span class="built_in">instantiate</span>();</span><br><span class="line">        CameraService::<span class="built_in">instantiate</span>();</span><br><span class="line">        AudioPolicyService::<span class="built_in">instantiate</span>();</span><br><span class="line">        SoundTriggerHwService::<span class="built_in">instantiate</span>();</span><br><span class="line">        RadioService::<span class="built_in">instantiate</span>();</span><br><span class="line">        <span class="built_in">registerExtensions</span>();</span><br><span class="line">        ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">startThreadPool</span>();</span><br><span class="line">        IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">joinThreadPool</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>AudioPolicyService</code>中，会在<code>onFristRef</code>方法中启动<code>AudioPolicyManager</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AudioPolicyService::onFirstRef</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        ....</span><br><span class="line">        <span class="comment">// start tone playback thread</span></span><br><span class="line">        mTonePlaybackThread = <span class="keyword">new</span> <span class="built_in">AudioCommandThread</span>(<span class="built_in">String8</span>(<span class="string">&quot;ApmTone&quot;</span>, <span class="keyword">this</span>));</span><br><span class="line">        <span class="comment">// start audio commands thread</span></span><br><span class="line">        mTonePlaybackThread = <span class="keyword">new</span> <span class="built_in">AudioCommandThread</span>(<span class="built_in">String8</span>(<span class="string">&quot;ApmAudio&quot;</span>, <span class="keyword">this</span>));</span><br><span class="line">        <span class="comment">// start output activity command thread</span></span><br><span class="line">        mTonePlaybackThread = <span class="keyword">new</span> <span class="built_in">AudioCommandThread</span>(<span class="built_in">String8</span>(<span class="string">&quot;ApmOutput&quot;</span>, <span class="keyword">this</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> USE_LEGACY_AUDIO_POLICY</span></span><br><span class="line">        <span class="comment">// 使用老版本的 audio policy 初始化方式</span></span><br><span class="line">        ....</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="comment">// 使用最新的 audio policy 初始化方式</span></span><br><span class="line">        <span class="built_in">ALOGI</span>(<span class="string">&quot;AudioPolicyService CSTOR in new mode&quot;</span>);</span><br><span class="line"></span><br><span class="line">        mAudioPolicyClient = <span class="keyword">new</span> <span class="built_in">AudioPolicyClient</span>(<span class="keyword">this</span>);</span><br><span class="line">        mAudioPolicyManager =<span class="built_in">createAudioPolicyManager</span>(mAudioPolicyClient);    <span class="comment">// 创建 AudioPolicyManager 对象</span></span><br><span class="line">        ....</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// load audio processing modules</span></span><br><span class="line">    sp&lt;AudioPolicyEffects&gt; audioPolicyEffects = <span class="keyword">new</span> <span class="built_in">AudioPolicyEffects</span>();</span><br><span class="line">    &#123;</span><br><span class="line">        ....</span><br><span class="line">        mAudioPolicyEffects = audioPolicyEffects;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createAudioPolicyManager</code>函数位于<code>frameworks/av/services/audiopolicy/manager/AudioPolicyFactory.cpp</code>文件，这个文件只有这一个函数，直接调用了<code>AudioPolicyManager</code>的构造函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">AudioPolicyInterface* <span class="title">createAudioPolicyManager</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        AudioPolicyClientInterface *clientInterface)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">AudioPolicyManager</span>(clientInterface);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>AudioPolicyManager</code>的构造函数中，会对<code>audio_policy.conf</code>文件(Android 7.0之后可以配置成audio_policy_configuration.xml)进行解析，加载所有的<code>HwModule</code>，创建输入输出流和播放、录音线程</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">AudioPolicyManager::<span class="built_in">AudioPolicyManager</span>(AudioPolicyClientInterface *clientInterface)</span><br><span class="line">    :</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> AUDIO_POLICY_TEST</span></span><br><span class="line">    <span class="built_in">Thread</span>(<span class="literal">false</span>),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//AUDIO_POLICY_TEST</span></span></span><br><span class="line">    <span class="built_in">mLimitRingtoneVolume</span>(<span class="literal">false</span>), <span class="built_in">mLastVoiceVolume</span>(<span class="number">-1.0f</span>),</span><br><span class="line">    <span class="built_in">mA2dpSuspended</span>(<span class="literal">false</span>),</span><br><span class="line">    <span class="built_in">mSpeakerDrcEnabled</span>(<span class="literal">false</span>),</span><br><span class="line">    <span class="built_in">mAudioPortGeneration</span>(<span class="number">1</span>),</span><br><span class="line">    <span class="built_in">mBeaconMuteRefCount</span>(<span class="number">0</span>),</span><br><span class="line">    <span class="built_in">mBeaconPlayingRefCount</span>(<span class="number">0</span>),</span><br><span class="line">    <span class="built_in">mBeaconMuted</span>(<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/** 加载audio_policy.conf文件 */</span></span><br><span class="line">    <span class="keyword">if</span> (ConfigParsingUtils::<span class="built_in">loadAudioPolicyConfig</span>(AUDIO_POLICY_VENDOR_CONFIG_FILE,</span><br><span class="line">                 mHwModules, mAvailableInputDevices, mAvailableOutputDevices,</span><br><span class="line">                 mDefaultOutputDevice, mSpeakerDrcEnabled) != NO_ERROR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ConfigParsingUtils::<span class="built_in">loadAudioPolicyConfig</span>(AUDIO_POLICY_CONFIG_FILE,</span><br><span class="line">                                  mHwModules, mAvailableInputDevices, mAvailableOutputDevices,</span><br><span class="line">                                  mDefaultOutputDevice, mSpeakerDrcEnabled) != NO_ERROR) &#123;</span><br><span class="line">            <span class="built_in">ALOGE</span>(<span class="string">&quot;could not load audio policy configuration file, setting defaults&quot;</span>);</span><br><span class="line">            <span class="built_in">defaultAudioPolicyConfig</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mAvailableOutputDevices and mAvailableInputDevices now contain all attached devices</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// must be done after reading the policy (since conditionned by Speaker Drc Enabling)</span></span><br><span class="line">    <span class="comment">/** 调节音量曲线 */</span></span><br><span class="line">    mEngine-&gt;<span class="built_in">initializeVolumeCurves</span>(mSpeakerDrcEnabled);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// open all output streams needed to access attached devices</span></span><br><span class="line">    <span class="type">audio_devices_t</span> outputDeviceTypes = mAvailableOutputDevices.<span class="built_in">types</span>();</span><br><span class="line">    <span class="type">audio_devices_t</span> inputDeviceTypes = mAvailableInputDevices.<span class="built_in">types</span>() &amp; ~AUDIO_DEVICE_BIT_IN;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; mHwModules.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        mHwModules[i]-&gt;mHandle = mpClientInterface-&gt;<span class="built_in">loadHwModule</span>(mHwModules[i]-&gt;mName);</span><br><span class="line">        <span class="keyword">if</span> (mHwModules[i]-&gt;mHandle == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">ALOGW</span>(<span class="string">&quot;could not open HW module %s&quot;</span>, mHwModules[i]-&gt;mName);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// open all output streams needed to access attached devices</span></span><br><span class="line">        <span class="comment">// except for direct output streams that are only opened when they are actually</span></span><br><span class="line">        <span class="comment">// required by an app.</span></span><br><span class="line">        <span class="comment">// This also validates mAvailableOutputDevices list</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; mHwModules[i]-&gt;mOutputProfiles.<span class="built_in">size</span>(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">const</span> sp&lt;IOProfile&gt; outProfile = mHwModules[i]-&gt;mOutputProfiles[j];</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">/** 获取采样率、通道数、数据格式等各音频参数 */</span></span><br><span class="line">            outputDesc-&gt;mDevice = profileType;</span><br><span class="line">            <span class="type">audio_config_t</span> config = AUDIO_CONFIG_INITIALIZER;</span><br><span class="line">            config.sample_rate = outputDesc-&gt;mSamplingRate;</span><br><span class="line">            config.channel_mask = outputDesc-&gt;mChannelMask;</span><br><span class="line">            config.format = outputDesc-&gt;mFormat;</span><br><span class="line">            <span class="type">audio_io_handle_t</span> output = AUDIO_IO_HANDLE_NONE;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 打开 outputStream 创建 playbackThread 线程 */</span></span><br><span class="line">            <span class="type">status_t</span> status = mpClientInterface-&gt;<span class="built_in">openOutput</span>(outProfile-&gt;<span class="built_in">getModuleHandle</span>(),</span><br><span class="line">                                                            &amp;output,</span><br><span class="line">                                                            &amp;config,</span><br><span class="line">                                                            &amp;outputDesc-&gt;mDevice,</span><br><span class="line">                                                            <span class="built_in">String8</span>(<span class="string">&quot;&quot;</span>),</span><br><span class="line">                                                            &amp;outputDesc-&gt;mLatency,</span><br><span class="line">                                                            outputDesc-&gt;mFlags);</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// open input streams needed to access attached devices to validate</span></span><br><span class="line">        <span class="comment">// mAvailableInputDevices list</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; mHwModules[i]-&gt;mInputProfiles.<span class="built_in">size</span>(); j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">const</span> sp&lt;IOProfile&gt; inProfile = mHwModules[i]-&gt;mInputProfiles[j];</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">            <span class="comment">/** 获取采样率、通道数、数据格式等各音频参数 */</span></span><br><span class="line">            <span class="type">audio_config_t</span> config = AUDIO_CONFIG_INITIALIZER;</span><br><span class="line">            config.sample_rate = inputDesc-&gt;mSamplingRate;</span><br><span class="line">            config.channel_mask = inputDesc-&gt;mChannelMask;</span><br><span class="line">            config.format = inputDesc-&gt;mFormat;</span><br><span class="line">            <span class="type">audio_io_handle_t</span> input = AUDIO_IO_HANDLE_NONE;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 打开 inputStream 创建 recordThread  线程 */</span></span><br><span class="line">            <span class="type">status_t</span> status = mpClientInterface-&gt;<span class="built_in">openInput</span>(inProfile-&gt;<span class="built_in">getModuleHandle</span>(),</span><br><span class="line">                                                           &amp;input,</span><br><span class="line">                                                           &amp;config,</span><br><span class="line">                                                           &amp;inputDesc-&gt;mDevice,</span><br><span class="line">                                                           address,</span><br><span class="line">                                                           AUDIO_SOURCE_MIC,</span><br><span class="line">                                                           AUDIO_INPUT_FLAG_NONE);</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/** 更新系统缓存的音频输出设备信息 */</span></span><br><span class="line">    <span class="built_in">updateDevicesAndOutputs</span>();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置文件加载"><a href="#配置文件加载" class="headerlink" title="配置文件加载"></a>配置文件加载</h2><p><code>audio_policy.conf</code>文件用于配置系统的音频设备，在<code>AudioPolicyManager</code>的构造方法中加载解析，通过<code>ConfigParsingUtils</code>的<code>loadAudioPolicyConfig</code>函数，解析这个文件，获取所有配置的输入输出设备类型以及各项配置，然后对所有获取到的<code>HwModule</code>进行遍历，通过<code>AudioFlinger</code>加载对应的so，生成音频设备</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">audio_module_handle_t</span> <span class="title">AudioFlinger::loadHwModule_l</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">audio_hw_device_t</span> *dev;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 加载so */</span></span><br><span class="line">    <span class="type">int</span> rc = <span class="built_in">load_audio_interface</span>(name, &amp;dev);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 添加音频设备 */</span></span><br><span class="line">    <span class="type">audio_module_handle_t</span> handle = <span class="built_in">nextUniqueId</span>();</span><br><span class="line">    mAudioHwDevs.<span class="built_in">add</span>(handle, <span class="keyword">new</span> <span class="built_in">AudioHwDevice</span>(handle, name, dev, flags));</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>load_audio_interface</code>函数中，会从<code>system/lib/hw</code>中找到对应于<code>name</code>的库，一般为<code>audio.[name].default.so</code>，这个库由音频设备商提供，系统默认的音频设备库由<code>hardware/mstar/audio</code>编译生成，对应<code>primary</code>的设备</p>
<p><code>audio_hw_device_t</code>为音频设备的实现，结构体在<code>hardware/libhardware/include/hardware/audio.h</code>中定义，每一个音频设备驱动都需要实现这个结构体定义的各个函数，所有操作音频设备都是通过这个结构体生成的对象实现的</p>
<h2 id="录音调用流程"><a href="#录音调用流程" class="headerlink" title="录音调用流程"></a>录音调用流程</h2><p><img src="/../../out/source/_posts/Android%20%E9%9F%B3%E9%A2%91%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/%E5%BD%95%E9%9F%B3%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B/Audio%20%E5%BD%95%E9%9F%B3%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B.png" alt="Audio 录音调用流程"></p>
<p>一般情况下，录音由Android App通过<code>AudioRecord</code>发起，<code>AudioRecord</code>通过jni调用Android框架libmedia中的<code>AudioRecord</code>，<code>AudioRecord</code>的构造函数直接调用<code>set</code>函数，在<code>set</code>函数中，会首先进行一些参数的设置，然后运行<code>recordThread</code>，打开录音设备(<code>IAudioRecord</code>)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AudioRecord::set</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_source_t</span> inputSource,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint32_t</span> sampleRate,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_format_t</span> format,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_channel_mask_t</span> channelMask,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">size_t</span> frameCount,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">callback_t</span> cbf,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">void</span>* user,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint32_t</span> notificationFrames,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">bool</span> threadCanCallJava,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> sessionId,</span></span></span><br><span class="line"><span class="params"><span class="function">        transfer_type transferType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_input_flags_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> uid,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">pid_t</span> pid,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> <span class="type">audio_attributes_t</span>* pAttributes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** 设置参数 */</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 打开 recordThread */</span></span><br><span class="line">    <span class="keyword">if</span> (cbf != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mAudioRecordThread = <span class="keyword">new</span> <span class="built_in">AudioRecordThread</span>(*<span class="keyword">this</span>, threadCanCallJava);</span><br><span class="line">        mAudioRecordThread-&gt;<span class="built_in">run</span>(<span class="string">&quot;AudioRecord&quot;</span>, ANDROID_PRIORITY_AUDIO);</span><br><span class="line">        <span class="comment">// thread begins in paused state, and will not reference us until start()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the IAudioRecord</span></span><br><span class="line">    <span class="type">status_t</span> status = <span class="built_in">openRecord_l</span>(<span class="number">0</span> <span class="comment">/*epoch*/</span>, mOpPackageName);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>set</code>函数调用了<code>openRecord_l</code>函数，在<code>openRecord_l</code>函数中，首先获取了<code>AudioFlinger</code>的实例，然后通过构造<code>AudioRecord</code>时传进来的参数，获取对应的<code>audio_io_handle_t</code>句柄</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">audio_io_handle_t</span> input;</span><br><span class="line"><span class="type">status_t</span> status = AudioSystem::<span class="built_in">getInputForAttr</span>(&amp;mAttributes, &amp;input,</span><br><span class="line">                                    (<span class="type">audio_session_t</span>)mSessionId,</span><br><span class="line">                                    IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">getCallingUid</span>(),</span><br><span class="line">                                    mSampleRate, mFormat, mChannelMask,</span><br><span class="line">                                    mFlags, mSelectedDeviceId);</span><br></pre></td></tr></table></figure>

<p>然后，通过<code>AudioFlinger</code>打开录音</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;IAudioRecord&gt; record = audioFlinger-&gt;<span class="built_in">openRecord</span>(input,</span><br><span class="line">                                                   mSampleRate,</span><br><span class="line">                                                   mFormat,</span><br><span class="line">                                                   mChannelMask,</span><br><span class="line">                                                   opPackageName,</span><br><span class="line">                                                   &amp;temp,</span><br><span class="line">                                                   &amp;trackFlags,</span><br><span class="line">                                                   tid,</span><br><span class="line">                                                   mClientUid,</span><br><span class="line">                                                   &amp;mSessionId,</span><br><span class="line">                                                   &amp;notificationFrames,</span><br><span class="line">                                                   iMem,</span><br><span class="line">                                                   bufferMem,</span><br><span class="line">                                                   &amp;status);</span><br></pre></td></tr></table></figure>

<h2 id="录音设备选择"><a href="#录音设备选择" class="headerlink" title="录音设备选择"></a>录音设备选择</h2><p>录音调用流程中，在<code>AudioRecord</code>的构造函数中，通过<code>set</code>函数调用了<code>AudioSystem::getInputForAttr</code>以获得匹配的录音设备，我们着重关注第一个参数<code>mAttributes</code></p>
<p>在Android App中，我们通过实例化一个<code>AudioRecord(java)</code>来进行录音，通常调用的构造方法为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AudioRecord</span><span class="params">(<span class="type">int</span> audioSource, <span class="type">int</span> sampleRateInHz, <span class="type">int</span> channelConfig, <span class="type">int</span> audioFormat,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> bufferSizeInBytes)</span></span><br><span class="line"><span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">    <span class="built_in">this</span>((<span class="keyword">new</span> <span class="title class_">AudioAttributes</span>.Builder())</span><br><span class="line">                .setInternalCapturePreset(audioSource)</span><br><span class="line">                .build(),</span><br><span class="line">            (<span class="keyword">new</span> <span class="title class_">AudioFormat</span>.Builder())</span><br><span class="line">                .setChannelMask(getChannelMaskFromLegacyConfig(channelConfig,</span><br><span class="line">                                    <span class="literal">true</span><span class="comment">/*allow legacy configurations*/</span>))</span><br><span class="line">                .setEncoding(audioFormat)</span><br><span class="line">                .setSampleRate(sampleRateInHz)</span><br><span class="line">                .build(),</span><br><span class="line">            bufferSizeInBytes,</span><br><span class="line">            AudioManager.AUDIO_SESSION_ID_GENERATE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里需要传递<code>audioSource</code>，<code>sampleRateInHz</code>等参数，并将这些参数构造成了一个<code>AudioAttributes</code>的对象，其中<code>audioSource</code>就是选择的音频源，在Android App端，可以选择的源如下(<code>frameworks/base/media/java/android/media/MediaRecorder.java</code>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">AudioSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">AudioSource</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">AUDIO_SOURCE_INVALID</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do not change these values without updating their counterparts</span></span><br><span class="line"><span class="comment">   * in system/media/audio/include/system/audio.h!</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Default audio source **/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Microphone audio source */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MIC</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Voice call uplink (Tx) audio source */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VOICE_UPLINK</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Voice call downlink (Rx) audio source */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VOICE_DOWNLINK</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Voice call uplink + downlink audio source */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VOICE_CALL</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Microphone audio source with same orientation as camera if available, the main</span></span><br><span class="line"><span class="comment">     *  device microphone otherwise */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CAMCORDER</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Microphone audio source tuned for voice recognition if available, behaves like</span></span><br><span class="line"><span class="comment">     *  &#123;<span class="doctag">@link</span> #DEFAULT&#125; otherwise. */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VOICE_RECOGNITION</span> <span class="operator">=</span> <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Microphone audio source tuned for voice communications such as VoIP. It</span></span><br><span class="line"><span class="comment">     *  will for instance take advantage of echo cancellation or automatic gain control</span></span><br><span class="line"><span class="comment">     *  if available. It otherwise behaves like &#123;<span class="doctag">@link</span> #DEFAULT&#125; if no voice processing</span></span><br><span class="line"><span class="comment">     *  is applied.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VOICE_COMMUNICATION</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Audio source for a submix of audio streams to be presented remotely.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * An application can use this audio source to capture a mix of audio streams</span></span><br><span class="line"><span class="comment">     * that should be transmitted to a remote receiver such as a Wifi display.</span></span><br><span class="line"><span class="comment">     * While recording is active, these audio streams are redirected to the remote</span></span><br><span class="line"><span class="comment">     * submix instead of being played on the device speaker or headset.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;&lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Certain streams are excluded from the remote submix, including</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> AudioManager#STREAM_RING&#125;, &#123;<span class="doctag">@link</span> AudioManager#STREAM_ALARM&#125;,</span></span><br><span class="line"><span class="comment">     * and &#123;<span class="doctag">@link</span> AudioManager#STREAM_NOTIFICATION&#125;.  These streams will continue</span></span><br><span class="line"><span class="comment">     * to be presented locally as usual.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;&lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Capturing the remote submix audio requires the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> android.Manifest.permission#CAPTURE_AUDIO_OUTPUT&#125; permission.</span></span><br><span class="line"><span class="comment">     * This permission is reserved for use by system components and is not available to</span></span><br><span class="line"><span class="comment">     * third-party applications.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REMOTE_SUBMIX</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MStar Android Patch Begin</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     * BT PCM data send from remote devices which needs to be processed as PCM input</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BT_MIC</span> <span class="operator">=</span> <span class="number">9</span>;</span><br><span class="line">    <span class="comment">// MStar Android Patch End</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Audio source for capturing broadcast radio tuner output.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SystemApi</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RADIO_TUNER</span> <span class="operator">=</span> <span class="number">1998</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Audio source for preemptible, low-priority software hotword detection</span></span><br><span class="line"><span class="comment">     * It presents the same gain and pre processing tuning as &#123;<span class="doctag">@link</span> #VOICE_RECOGNITION&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * An application should use this audio source when it wishes to do</span></span><br><span class="line"><span class="comment">     * always-on software hotword detection, while gracefully giving in to any other application</span></span><br><span class="line"><span class="comment">     * that might want to read from the microphone.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * This is a hidden audio source.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SystemApi</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HOTWORD</span> <span class="operator">=</span> <span class="number">1999</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传递进来的参数jni，调用到<code>AudioRecord(cpp)</code>的<code>set</code>函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AudioRecord::set</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_source_t</span> inputSource,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint32_t</span> sampleRate,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_format_t</span> format,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_channel_mask_t</span> channelMask,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">size_t</span> frameCount,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">callback_t</span> cbf,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">void</span>* user,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">uint32_t</span> notificationFrames,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">bool</span> threadCanCallJava,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> sessionId,</span></span></span><br><span class="line"><span class="params"><span class="function">        transfer_type transferType,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">audio_input_flags_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> uid,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">pid_t</span> pid,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> <span class="type">audio_attributes_t</span>* pAttributes)</span></span></span><br></pre></td></tr></table></figure>

<p>在这里，<code>inputSource</code>即表示音频源，<code>audio_source_t</code>在<code>audio.h</code>中定义(<code>system/media/audio/include/system/audio.h</code>)且与<code>AudioSource</code>中的定义一一对应</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    AUDIO_SOURCE_DEFAULT             = <span class="number">0</span>,</span><br><span class="line">    AUDIO_SOURCE_MIC                 = <span class="number">1</span>,</span><br><span class="line">    AUDIO_SOURCE_VOICE_UPLINK        = <span class="number">2</span>,</span><br><span class="line">    AUDIO_SOURCE_VOICE_DOWNLINK      = <span class="number">3</span>,</span><br><span class="line">    AUDIO_SOURCE_VOICE_CALL          = <span class="number">4</span>,</span><br><span class="line">    AUDIO_SOURCE_CAMCORDER           = <span class="number">5</span>,</span><br><span class="line">    AUDIO_SOURCE_VOICE_RECOGNITION   = <span class="number">6</span>,</span><br><span class="line">    AUDIO_SOURCE_VOICE_COMMUNICATION = <span class="number">7</span>,</span><br><span class="line">    AUDIO_SOURCE_REMOTE_SUBMIX       = <span class="number">8</span>, <span class="comment">/* Source for the mix to be presented remotely.      */</span></span><br><span class="line">                                          <span class="comment">/* An example of remote presentation is Wifi Display */</span></span><br><span class="line">                                          <span class="comment">/*  where a dongle attached to a TV can be used to   */</span></span><br><span class="line">                                          <span class="comment">/*  play the mix captured by this audio source.      */</span></span><br><span class="line">    <span class="comment">// MStar Android Patch Begin</span></span><br><span class="line">    AUDIO_SOURCE_BLUETOOTH_MIC       = <span class="number">9</span>,</span><br><span class="line">    AUDIO_SOURCE_CAPTURE_DEVICE0     = <span class="number">10</span>,</span><br><span class="line">    AUDIO_SOURCE_CAPTURE_DEVICE1     = <span class="number">11</span>,</span><br><span class="line">    AUDIO_SOURCE_A2DP                = <span class="number">12</span>, <span class="comment">/* restricted to internal audioflinger routing */</span></span><br><span class="line">    <span class="comment">// MStar Android Patch End</span></span><br><span class="line">    AUDIO_SOURCE_CNT,</span><br><span class="line">    AUDIO_SOURCE_MAX                 = AUDIO_SOURCE_CNT - <span class="number">1</span>,</span><br><span class="line">    AUDIO_SOURCE_FM_TUNER            = <span class="number">1998</span>,</span><br><span class="line">    AUDIO_SOURCE_HOTWORD             = <span class="number">1999</span>, <span class="comment">/* A low-priority, preemptible audio source for</span></span><br><span class="line"><span class="comment">                                                for background software hotword detection.</span></span><br><span class="line"><span class="comment">                                                Same tuning as AUDIO_SOURCE_VOICE_RECOGNITION.</span></span><br><span class="line"><span class="comment">                                                Used only internally to the framework. Not exposed</span></span><br><span class="line"><span class="comment">                                                at the audio HAL. */</span></span><br><span class="line">&#125; <span class="type">audio_source_t</span>;</span><br></pre></td></tr></table></figure>

<p>我们再回头看<code>getInputForAttr</code>函数(<code>frameworks/av/media/libmedia/AudioSystem.cpp</code>)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AudioSystem::getInputForAttr</span><span class="params">(<span class="type">const</span> <span class="type">audio_attributes_t</span> *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">audio_io_handle_t</span> *input,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">audio_session_t</span> session,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">uid_t</span> uid,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">uint32_t</span> samplingRate,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">audio_format_t</span> format,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">audio_channel_mask_t</span> channelMask,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">audio_input_flags_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">audio_port_handle_t</span> selectedDeviceId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> sp&lt;IAudioPolicyService&gt;&amp; aps = AudioSystem::<span class="built_in">get_audio_policy_service</span>();</span><br><span class="line">    <span class="keyword">if</span> (aps == <span class="number">0</span>) <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    <span class="keyword">return</span> aps-&gt;<span class="built_in">getInputForAttr</span>(</span><br><span class="line">            attr, input, session, uid, samplingRate, format, channelMask, flags, selectedDeviceId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里直接调用的<code>AudioPolicyService</code>的<code>getInputForAttr</code>函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AudioPolicyManager::getInputForAttr</span><span class="params">(<span class="type">const</span> <span class="type">audio_attributes_t</span> *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">audio_io_handle_t</span> *input,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">audio_session_t</span> session,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">uid_t</span> uid,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">uint32_t</span> samplingRate,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">audio_format_t</span> format,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">audio_channel_mask_t</span> channelMask,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">audio_input_flags_t</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">audio_port_handle_t</span> selectedDeviceId,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="type">input_type_t</span> *inputType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *input = AUDIO_IO_HANDLE_NONE;</span><br><span class="line">    *inputType = API_INPUT_INVALID;</span><br><span class="line">    <span class="type">audio_devices_t</span> device;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inputSource == AUDIO_SOURCE_REMOTE_SUBMIX &amp;&amp;</span><br><span class="line">            <span class="built_in">strncmp</span>(attr-&gt;tags, <span class="string">&quot;addr=&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;addr=&quot;</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">status_t</span> ret = mPolicyMixes.<span class="built_in">getInputMixForAttr</span>(*attr, &amp;policyMix);</span><br><span class="line">        <span class="keyword">if</span> (ret != NO_ERROR) &#123;</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        *inputType = API_INPUT_MIX_EXT_POLICY_REROUTE;</span><br><span class="line">        device = AUDIO_DEVICE_IN_REMOTE_SUBMIX;</span><br><span class="line">        address = <span class="built_in">String8</span>(attr-&gt;tags + <span class="built_in">strlen</span>(<span class="string">&quot;addr=&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        device = <span class="built_in">getDeviceAndMixForInputSource</span>(inputSource, &amp;policyMix);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里先判断<code>inputSource</code>是否为<code>AUDIO_SOURCE_REMOTE_SUBMIX</code>，如果时其他源，则调用<code>getDeviceAndMixForInputSource</code>函数</p>
<p>这里我们注意一下<code>audio_devices_t</code>这个数据类型，在<code>audio.h</code>中定义，这个数据类型就表示一个具体类型的音频设备，我们再<code>audio_polic.conf</code>中定义音频设备时，<code>device</code>字段的取值就需要是这个数据类型中定义的值</p>
<p>再来看<code>getDeviceAndMixForInputSource</code>函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">audio_devices_t</span> <span class="title">AudioPolicyManager::getDeviceAndMixForInputSource</span><span class="params">(<span class="type">audio_source_t</span> inputSource,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                  AudioMix **policyMix)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">audio_devices_t</span> availableDeviceTypes = mAvailableInputDevices.<span class="built_in">types</span>() &amp; ~AUDIO_DEVICE_BIT_IN;</span><br><span class="line">    <span class="type">audio_devices_t</span> selectedDeviceFromMix =</span><br><span class="line">           mPolicyMixes.<span class="built_in">getDeviceAndMixForInputSource</span>(inputSource, availableDeviceTypes, policyMix);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (selectedDeviceFromMix != AUDIO_DEVICE_NONE) &#123;</span><br><span class="line">        <span class="keyword">return</span> selectedDeviceFromMix;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getDeviceForInputSource</span>(inputSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里首先调用了<code>getDeviceAndMixForInputSource</code>函数，这个应该是混音通道，我们先不看，一般情况，我们调用录音，会走到<code>getDeviceForInputSource</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">audio_devices_t</span> <span class="title">AudioPolicyManager::getDeviceForInputSource</span><span class="params">(<span class="type">audio_source_t</span> inputSource)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> routeIndex = <span class="number">0</span>; routeIndex &lt; mInputRoutes.<span class="built_in">size</span>(); routeIndex++) &#123;</span><br><span class="line">         sp&lt;SessionRoute&gt; route = mInputRoutes.<span class="built_in">valueAt</span>(routeIndex);</span><br><span class="line">         <span class="keyword">if</span> (inputSource == route-&gt;mSource &amp;&amp; route-&gt;<span class="built_in">isActive</span>()) &#123;</span><br><span class="line">             <span class="keyword">return</span> route-&gt;mDeviceDescriptor-&gt;<span class="built_in">type</span>();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> mEngine-&gt;<span class="built_in">getDeviceForInputSource</span>(inputSource);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getDeviceForInputSource</code>函数直接调用了<code>Engine</code>的<code>getDeviceForInputSource</code>函数(<code>frameworks/av/services/audiopolicy/enginedefault/src/Engine.cpp</code>)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">audio_devices_t</span> <span class="title">Engine::getDeviceForInputSource</span><span class="params">(<span class="type">audio_source_t</span> inputSource)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> DeviceVector &amp;availableOutputDevices = mApmObserver-&gt;<span class="built_in">getAvailableOutputDevices</span>();</span><br><span class="line">    <span class="type">const</span> DeviceVector &amp;availableInputDevices = mApmObserver-&gt;<span class="built_in">getAvailableInputDevices</span>();</span><br><span class="line">    <span class="type">const</span> SwAudioOutputCollection &amp;outputs = mApmObserver-&gt;<span class="built_in">getOutputs</span>();</span><br><span class="line">    <span class="type">audio_devices_t</span> availableDeviceTypes = availableInputDevices.<span class="built_in">types</span>() &amp; ~AUDIO_DEVICE_BIT_IN;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> device = AUDIO_DEVICE_NONE;</span><br><span class="line">    <span class="comment">// MStar Android Patch Begin</span></span><br><span class="line">    <span class="type">char</span> value[PROPERTY_VALUE_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">// MStar Android Patch End</span></span><br><span class="line">    <span class="keyword">switch</span> (inputSource) &#123;</span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_VOICE_UPLINK:</span><br><span class="line">      <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_VOICE_CALL) &#123;</span><br><span class="line">          device = AUDIO_DEVICE_IN_VOICE_CALL;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_DEFAULT:</span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_MIC:</span><br><span class="line">    <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BLUETOOTH_A2DP) &#123;</span><br><span class="line">        device = AUDIO_DEVICE_IN_BLUETOOTH_A2DP;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((mForceUse[AUDIO_POLICY_FORCE_FOR_RECORD] == AUDIO_POLICY_FORCE_BT_SCO) &amp;&amp;</span><br><span class="line">        (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET)) &#123;</span><br><span class="line">        device = AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_WIRED_HEADSET) &#123;</span><br><span class="line">        device = AUDIO_DEVICE_IN_WIRED_HEADSET;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_USB_DEVICE) &#123;</span><br><span class="line">        device = AUDIO_DEVICE_IN_USB_DEVICE;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BUILTIN_MIC) &#123;</span><br><span class="line">        device = AUDIO_DEVICE_IN_BUILTIN_MIC;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_VOICE_COMMUNICATION:</span><br><span class="line">        <span class="comment">// Allow only use of devices on primary input if in call and HAL does not support routing</span></span><br><span class="line">        <span class="comment">// to voice call path.</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">getPhoneState</span>() == AUDIO_MODE_IN_CALL) &amp;&amp;</span><br><span class="line">                (availableOutputDevices.<span class="built_in">types</span>() &amp; AUDIO_DEVICE_OUT_TELEPHONY_TX) == <span class="number">0</span>) &#123;</span><br><span class="line">            sp&lt;AudioOutputDescriptor&gt; primaryOutput = outputs.<span class="built_in">getPrimaryOutput</span>();</span><br><span class="line">            availableDeviceTypes =</span><br><span class="line">                    availableInputDevices.<span class="built_in">getDevicesFromHwModule</span>(primaryOutput-&gt;<span class="built_in">getModuleHandle</span>())</span><br><span class="line">                    &amp; ~AUDIO_DEVICE_BIT_IN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (mForceUse[AUDIO_POLICY_FORCE_FOR_COMMUNICATION]) &#123;</span><br><span class="line">        <span class="keyword">case</span> AUDIO_POLICY_FORCE_BT_SCO:</span><br><span class="line">            <span class="comment">// if SCO device is requested but no SCO device is available, fall back to default case</span></span><br><span class="line">            <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET) &#123;</span><br><span class="line">                device = AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// FALL THROUGH</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:    <span class="comment">// FORCE_NONE</span></span><br><span class="line">            <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_WIRED_HEADSET) &#123;</span><br><span class="line">                device = AUDIO_DEVICE_IN_WIRED_HEADSET;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_USB_DEVICE) &#123;</span><br><span class="line">                device = AUDIO_DEVICE_IN_USB_DEVICE;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BUILTIN_MIC) &#123;</span><br><span class="line">                device = AUDIO_DEVICE_IN_BUILTIN_MIC;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> AUDIO_POLICY_FORCE_SPEAKER:</span><br><span class="line">            <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BACK_MIC) &#123;</span><br><span class="line">                device = AUDIO_DEVICE_IN_BACK_MIC;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BUILTIN_MIC) &#123;</span><br><span class="line">                device = AUDIO_DEVICE_IN_BUILTIN_MIC;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MStar Android Patch Begin</span></span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_BLUETOOTH_MIC:</span><br><span class="line">        <span class="keyword">if</span> (mForceUse[AUDIO_POLICY_FORCE_FOR_RECORD] == AUDIO_POLICY_FORCE_BT_MIC &amp;&amp;</span><br><span class="line">                availableDeviceTypes &amp; AUDIO_DEVICE_IN_BLUETOOTH_MIC) &#123;</span><br><span class="line">                device = AUDIO_DEVICE_IN_BLUETOOTH_MIC;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BACK_MIC) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_BACK_MIC;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// MStar Android Patch End</span></span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_VOICE_RECOGNITION:</span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_HOTWORD:</span><br><span class="line">        <span class="keyword">if</span> (mForceUse[AUDIO_POLICY_FORCE_FOR_RECORD] == AUDIO_POLICY_FORCE_BT_SCO &amp;&amp;</span><br><span class="line">                availableDeviceTypes &amp; AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_BLUETOOTH_SCO_HEADSET;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_WIRED_HEADSET) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_WIRED_HEADSET;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_USB_DEVICE) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_USB_DEVICE;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BUILTIN_MIC) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_BUILTIN_MIC;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// MStar Android Patch Begin</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">property_get</span>(<span class="string">&quot;mstar.bt.driver&quot;</span>, value, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(value, <span class="string">&quot;bcm&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mForceUse[AUDIO_POLICY_FORCE_FOR_RECORD] == AUDIO_POLICY_FORCE_BT_MIC &amp;&amp;</span><br><span class="line">                    (inputSource == AUDIO_SOURCE_VOICE_RECOGNITION ||</span><br><span class="line">                    inputSource == AUDIO_SOURCE_MIC)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BACK_MIC) &#123;</span><br><span class="line">                        device = AUDIO_DEVICE_IN_BACK_MIC;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        device = AUDIO_DEVICE_IN_BLUETOOTH_MIC;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">ALOGE</span>(<span class="string">&quot;picked the Broadcom MIC&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(value, <span class="string">&quot;mtk&quot;</span>) || !<span class="built_in">strcmp</span>(value, <span class="string">&quot;rtk&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((inputSource == AUDIO_SOURCE_VOICE_RECOGNITION ||</span><br><span class="line">                    inputSource == AUDIO_SOURCE_MIC)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BACK_MIC) &#123;</span><br><span class="line">                        device = AUDIO_DEVICE_IN_BACK_MIC;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        device = AUDIO_DEVICE_IN_BLUETOOTH_MIC;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">ALOGE</span>(<span class="string">&quot;picked the MtkRc MIC&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//other bt to do ???</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;%s device:%x &quot;</span>, __FUNCTION__, device);</span><br><span class="line">        <span class="comment">// MStar Android Patch End</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_CAMCORDER:</span><br><span class="line">        <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BACK_MIC) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_BACK_MIC;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_BUILTIN_MIC) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_BUILTIN_MIC;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_VOICE_DOWNLINK:</span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_VOICE_CALL:</span><br><span class="line">        <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_VOICE_CALL) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_VOICE_CALL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> AUDIO_SOURCE_REMOTE_SUBMIX:</span><br><span class="line">        <span class="keyword">if</span> (availableDeviceTypes &amp; AUDIO_DEVICE_IN_REMOTE_SUBMIX) &#123;</span><br><span class="line">            device = AUDIO_DEVICE_IN_REMOTE_SUBMIX;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> AUDIO_SOURCE_FM_TUNER:</span><br><span class="line">        <span class="comment">//if (availableDeviceTypes &amp; AUDIO_DEVICE_IN_FM_TUNER) &#123;</span></span><br><span class="line">        <span class="comment">//    device = AUDIO_DEVICE_IN_FM_TUNER;</span></span><br><span class="line">        <span class="comment">//&#125;</span></span><br><span class="line">        device = AUDIO_DEVICE_IN_BLUETOOTH_A2DP;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">ALOGW</span>(<span class="string">&quot;getDeviceForInputSource() invalid input source %d&quot;</span>, inputSource);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ALOGE</span>(<span class="string">&quot;getDeviceForInputSource()input source %d, device %08x&quot;</span>, inputSource, device);</span><br><span class="line">    <span class="keyword">return</span> device;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数会根据给进来的音频源参数，选择合适并且可用的音频设备，由此，就完成了从Android App层面音频源(<code>AudioSource</code>)到Audio Hal(<code>audio_policy.conf</code>)的调用</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Letter</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://nevermindzzt.github.io/2020/10/15/Android%20%E9%9F%B3%E9%A2%91%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/">http://nevermindzzt.github.io/2020/10/15/Android%20%E9%9F%B3%E9%A2%91%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2020/04/10/GoSLIP.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/20/C%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9D%97%E5%8C%96%E7%BC%96%E7%A8%8B%E7%9A%84%E5%AE%8C%E7%BE%8E%E8%A7%A3%E8%80%A6/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">C语言模块化编程的完美解耦</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/26/STM32%E4%BB%8E%E5%8E%9F%E7%90%86%E5%85%A5%E9%97%A8(%E4%B8%80)-%E7%82%B9%E7%81%AF(%E4%B8%8A%E7%AF%87)/"><img class="next-cover" src="https://s1.ax1x.com/2020/04/10/GoSbVI.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">STM32从原理入门(一)-点灯(上篇)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2019/10/21/Andorid%20%E6%8A%80%E5%B7%A7%E6%80%BB%E7%BB%93/" title="Android 技巧总结"><img class="cover" src="https://s1.ax1x.com/2020/04/10/GoSbVI.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-10-21</div><div class="title">Android 技巧总结</div></div></a></div><div><a href="/2019/07/19/Android%20%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A2%9C%E8%89%B2%E9%80%89%E6%8B%A9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="Android 自定义颜色选择器的实现"><img class="cover" src="https://s1.ax1x.com/2020/04/10/GIXGRJ.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-07-19</div><div class="title">Android 自定义颜色选择器的实现</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s1.ax1x.com/2020/04/10/GI7cM6.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Letter</div><div class="author-info__description"></div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">15</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">12</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">5</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/NevermindZZT"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/NevermindZZT" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:nevermindzzt@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fa fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.</span> <span class="toc-text">配置文件加载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%95%E9%9F%B3%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">录音调用流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%95%E9%9F%B3%E8%AE%BE%E5%A4%87%E9%80%89%E6%8B%A9"><span class="toc-number">4.</span> <span class="toc-text">录音设备选择</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2020/12/27/c%E8%AF%AD%E8%A8%80%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2/" title="c语言上下文的快速切换"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="c语言上下文的快速切换"/></a><div class="content"><a class="title" href="/2020/12/27/c%E8%AF%AD%E8%A8%80%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2/" title="c语言上下文的快速切换">c语言上下文的快速切换</a><time datetime="2020-12-27T06:14:23.000Z" title="Created 2020-12-27 14:14:23">2020-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/12/20/C%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9D%97%E5%8C%96%E7%BC%96%E7%A8%8B%E7%9A%84%E5%AE%8C%E7%BE%8E%E8%A7%A3%E8%80%A6/" title="C语言模块化编程的完美解耦"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="C语言模块化编程的完美解耦"/></a><div class="content"><a class="title" href="/2020/12/20/C%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9D%97%E5%8C%96%E7%BC%96%E7%A8%8B%E7%9A%84%E5%AE%8C%E7%BE%8E%E8%A7%A3%E8%80%A6/" title="C语言模块化编程的完美解耦">C语言模块化编程的完美解耦</a><time datetime="2020-12-20T05:57:02.000Z" title="Created 2020-12-20 13:57:02">2020-12-20</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/10/15/Android%20%E9%9F%B3%E9%A2%91%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/" title="Android 音频框架分析"><img src="https://s1.ax1x.com/2020/04/10/GoSLIP.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Android 音频框架分析"/></a><div class="content"><a class="title" href="/2020/10/15/Android%20%E9%9F%B3%E9%A2%91%E6%A1%86%E6%9E%B6%E5%88%86%E6%9E%90/" title="Android 音频框架分析">Android 音频框架分析</a><time datetime="2020-10-15T02:45:00.000Z" title="Created 2020-10-15 10:45:00">2020-10-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/07/26/STM32%E4%BB%8E%E5%8E%9F%E7%90%86%E5%85%A5%E9%97%A8(%E4%B8%80)-%E7%82%B9%E7%81%AF(%E4%B8%8A%E7%AF%87)/" title="STM32从原理入门(一)-点灯(上篇)"><img src="https://s1.ax1x.com/2020/04/10/GoSbVI.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="STM32从原理入门(一)-点灯(上篇)"/></a><div class="content"><a class="title" href="/2020/07/26/STM32%E4%BB%8E%E5%8E%9F%E7%90%86%E5%85%A5%E9%97%A8(%E4%B8%80)-%E7%82%B9%E7%81%AF(%E4%B8%8A%E7%AF%87)/" title="STM32从原理入门(一)-点灯(上篇)">STM32从原理入门(一)-点灯(上篇)</a><time datetime="2020-07-26T07:07:00.000Z" title="Created 2020-07-26 15:07:00">2020-07-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/07/19/STM32%E4%BB%8E%E5%8E%9F%E7%90%86%E5%85%A5%E9%97%A8(%E9%9B%B6)-%E8%B5%B7%E7%82%B9/" title="STM32从原理入门(零)-起点"><img src="https://s1.ax1x.com/2020/04/10/GoSLIP.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="STM32从原理入门(零)-起点"/></a><div class="content"><a class="title" href="/2020/07/19/STM32%E4%BB%8E%E5%8E%9F%E7%90%86%E5%85%A5%E9%97%A8(%E9%9B%B6)-%E8%B5%B7%E7%82%B9/" title="STM32从原理入门(零)-起点">STM32从原理入门(零)-起点</a><time datetime="2020-07-19T10:18:00.000Z" title="Created 2020-07-19 18:18:00">2020-07-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Letter</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '2ee9f0cc1bb3ec04b24e',
      clientSecret: 'd3379b0fc95af001102c846e79e5e63ac5e24739',
      repo: 'nevermindzzt.github.io',
      owner: 'NevermindZZT',
      admin: ['NevermindZZT'],
      id: 'ce0fec81ce8f828435c51bb9908faa6c',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-heart" src="/true" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>